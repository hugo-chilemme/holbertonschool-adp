<!DOCTYPE html>
<html lang="EN_en">
<head>

    <title> </title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;200;300;400;500;600;700;800;900&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <link rel="stylesheet" href="./assets/common.css">
    <link rel="stylesheet" href="./assets/navbar.css">
    <link rel="stylesheet" href="./assets/contains.css">
</head>
<body>

    <aside>

        <header class="navbar">

            <i class='bx bx-home-alt-2' ></i>

        </header>

        <aside class="contains">

            <header>

                <div class="menu">
                    <version-text> </version-text>
                    <div class="lists">

                    </div>
                </div>

                <div class="right">
                    <span class="weather">
                        <value>9.3</value> <celcus>Â°C</celcus>
                    </span>
                </div>

            </header>

            <section class="committers">

                <div class="current-comitter unshow">

                    <h1> </h1>
                    <div class="about-committer">
                        <h3> <img src=""> Published by <author> </author> </h3>
                        <div class="experience-comitter">
                            <span><i id="icon" class='bx bx-chevron-up'></i> <value></value></span>
                        </div>
                    </div>
                </div>

                <div class="scoreboard">

                    
                </div>

            </section>

        </aside>

    </aside>

</body>
<footer>

    <script>

            const d = document;
            const schedule = [

                // Recurring event

                { day: [1], hour: 9, minute: 0, title:"Check-in", link: 'zoommtg://zoom.us/join?confno=83251922994&pwd=QlMwV2J3N2lDbGFmQkdaN0FYalNzZz09' },

                { day: [1, 2, 3, 4, 5], hour: 20, minute: 59, title: "Speaker Of the Day", link: 'zoommtg://zoom.us/join?confno=84822594283&pwd=eXhPV1BUdVBGU1BXaWVaQllqN0luZz09' },

                { day: [1, 2, 3, 4, 5], hour: 11, minute: 45, title: "Stand-up", link: 'zoommtg://zoom.us/join?confno=83392530685&pwd=SEdOTUpibVlOTTU0bDFHNEdPVll5QT09' },

                { day: [5], title: "France Wrap-up", hour: 15, minute: 30, link: 'zoommtg://zoom.us/join?confno=87494744554&pwd=YzJkZ3lvMml3QXpjejRvaWRYaDVtQT09' },


                // Temporary event


            ];


            const event = {

                nexts: () => {

                    const now = new Date();
                    let events = [];

                    for (const event of schedule)
                    {       

                        if ( event.day.includes( now.getDay() ) && event.hour >= now.getHours() ) 
                        {

                            if (event.hour == now.getHours() && event.minute <= now.getMinutes())
                            {

                                continue;

                            }

                            events.push(event);

                        }

                    }
                    return events;

                },

                next: () => event.nexts()[0],

            }


            const screen = {

                version: undefined,

                update: {

                    // clock: (h, m, s) => d.querySelector('#clock').innerHTML = `${h}:${m}<span>${s}</span>`,

                    weather: (temperature) => d.querySelector('.weather value').innerText = temperature,

                    version: (version) => d.querySelector('version-text').innerText = version,

                    event: (title, diff) => {

                        const plural = (number, word) => number > 1 ? word + "s" : word; 
                        const ONE_HOUR = (60000 * 60);
                        
                        if ( diff < ONE_HOUR )
                        {

                            const min = diff.getMinutes();
                            const sec = diff.getSeconds();

                            let text = `dans ${min} ${plural(min, "minute")}`;
                            if ( min === 0 )
                            {

                                text = `dans ${sec} ${plural(sec, "seconde")}`;

                            }
                            console.log(text)
                        }



                    },

                    commit: (commit) => {


                        let XP_USER = commit.XP_BEFORE;

                        const exp_div = d.querySelector('.current-comitter .experience-comitter span');
                        const exp_val = d.querySelector('.current-comitter .experience-comitter span value');
                        const exp_ico = d.querySelector('.current-comitter .experience-comitter span #icon');

                        d.querySelector('.current-comitter h1').style.opacity = 0;
                        
                        exp_div.style.background = "#292929";
                        exp_val.innerText = "0";
                        exp_ico.classList.add('bx-chevron-up')
                        exp_ico.classList.remove('bx-chevron-down')


                        setTimeout(() => {

                           
                            d.querySelector('.current-comitter').classList.remove('unshow');
                            d.querySelector('.current-comitter h1').innerText = commit.TITLE.substring(0, 72);
                            d.querySelector('.current-comitter .about-committer author').innerText = commit.USER.Pseudo.split(' ')[0]
                            d.querySelector('.current-comitter .about-committer img').src = commit.USER.Avatar;
                            d.querySelector('.current-comitter h1').style.opacity = 1;

                            let scoreboard;
                            if ( d.querySelector('[scoreboard-id="'+commit.USER_ID+'"]') )
                                scoreboard = d.querySelector('[scoreboard-id="'+commit.USER_ID+'"] xp');

                            console.log(scoreboard)
                            setTimeout(() => {
                                const XP = commit.XP;

                                let num = 0;

                                const loop = async () => {
                                    if (XP > 0 && XP >= num) {
                                            exp_val.innerText = `${num}`;
                                            exp_div.style.background = '#2DA13F';
                                            if (scoreboard)
                                                scoreboard.innerText = `${XP_USER + num}`;

                                            if ( exp_ico.classList.contains('bx-chevron-down') )
                                            {
                                                exp_ico.classList.remove('bx-chevron-down')
                                                exp_ico.classList.add('bx-chevron-up')
                                            }
                                            num += 1;
                                            setTimeout(loop, 40);
                                    } else if (XP < 0 && XP <= num) {
                                            exp_val.innerText = `${num}`;
                                            exp_div.style.background = '#E33F3F';
                                            if (scoreboard)
                                                scoreboard.innerText = `${XP_USER + num}`;

                                            if ( exp_ico.classList.contains('bx-chevron-up') )
                                            {
                                                exp_ico.classList.remove('bx-chevron-up')
                                                exp_ico.classList.add('bx-chevron-down')
                                            }

                                            num -= 1;
                                            setTimeout(loop, 40);
                                    }
                                };
                                loop()
                            }, 500)

                            setTimeout(() => api('commits/'+ commit.ID + "/setDisplayed"), 5000)
                        }, 500)

                        
                    }

                },

            }

            const api = (event, callback = () => { }) => {

                const xhttp = new XMLHttpRequest();

                xhttp.onreadystatechange = function() {

                    if (this.readyState == 4 && this.status == 200) {

                        console.debug(`api  <= /v2/${event}`);

                        callback( JSON.parse( xhttp.responseText ) );

                    }
                }

                xhttp.open('GET', 'https://nexa.hugochilemme.com/api/v2/'+event, true);
                xhttp.send();

             }


            let last_commit;
            async function handleScreen () {

                api('commits?limit=1', (commits) => {

                    if (commits.length > 0) 
                    {
                        const commit = commits[0];
                        if (!last_commit || last_commit != commit.ID)
                        {

                            screen.update.commit(commit);
                            last_commit = commit.ID;

                        }


                    }

                } )
                api('scoreboard', (scoreboard) => {
                    scoreboard.reverse()
                    
                    const sb = d.querySelector('.scoreboard');
                    sb.innerHTML = "";
                    for (let i = 0; i < (scoreboard.length < 6 ? scoreboard.length : 6); i++)
                    {
                        const user = scoreboard[i];
                        let html = "";
                        html += ' <div class="item" scoreboard-id="'+ user.Login +'"> ';
                        html += '    <div class="picture"> <img src="' + user.Avatar + '"> </div> ';
                        html += '    <div class="about"> <h3> ' + user.Pseudo.split(' ')[0] + '</h3>  <h4>Cohort ' + user.Session + '</h4> </div> ';
                        html += '    <div class="right">  <span> <i class="bx bx-chevron-up" ></i> <xp>' + user.Experience + '</xp></span> </div> ';
                        html += ' </div> ';

                        sb.innerHTML += html;
                    }

                } )

                setTimeout(() => handleScreen(), 15000);

            }

            let isScheduled = false;
            async function handleClock () {


                const addDigit = (number) => number < 10 ? "0" + number : number;


                const date = new Date();

                const hours = addDigit( date.getHours() );
                const minutes = addDigit( date.getMinutes() );
                const seconds = addDigit( date.getSeconds() );

                screen.update.clock(hours, minutes, seconds);



                handleNextEvent();

            }

            const handleNextEvent = () => {

                const ev = event.next();
                const date = new Date();


                if ( !ev ) return;

                const event_date = new Date();
                event_date.setHours(ev.hour);
                event_date.setMinutes(ev.minute);
                event_date.setSeconds(0);
                event_date.setMilliseconds(0);

                const diff = new Date(event_date.getTime() - date.getTime());


                screen.update.event(ev.title, diff);

                const ONE_HOUR = (60000 * 60);

                if ( diff.getTime() < ONE_HOUR)
                {

                    if (diff.getMinutes() < 5 && !isScheduled)
                    {

                        window.open(ev.link);
                        isScheduled = true;
                        setTimeout(async () => isScheduled = false, 300000)

                    }

                }
            }


            async function handleLow () {

                api('weather', (weather) => screen.update.weather( weather.temperature ) )

                api('version', function (status) {

                    if (screen.version && screen.version != status.version) 
                    {

                        location.reload()

                    }

                    screen.version = status.version

                    screen.update.version( screen.version );

                } )


                setTimeout(() => handleLow(), 60000)

            }


            async function initializeEvent () {

                const events = d.querySelector('header .lists');

                for (const event of schedule)
                {

                    const { title, link } = event;

                    events.innerHTML += `<a href="${link}" target="_blanl">${title}</a>`;

                }
            }

            initializeEvent();
            handleScreen();
            handleLow();

    </script>
    
</footer>
</html>
