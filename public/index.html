<!DOCTYPE html>
<html lang="EN_en">
<head>

    <title> </title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;200;300;400;500;600;700;800;900&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <link rel="stylesheet" href="./assets/router.css">
    <link rel="stylesheet" href="./assets/common.css">
    <link rel="stylesheet" href="./assets/navbar.css">
    <link rel="stylesheet" href="./assets/contains.css">
</head>
<body>

    <aside>

        <header class="navbar">

            <i class='bx bx-home-alt-2 active' ></i>
            <i class='bx bx-calendar-event'></i>
            <i class='bx bx-git-commit' ></i>
            
        </header>

        <aside class="contains">

            <header>

                <div class="menu">
                    <span class="theme">
                        <i class='moon bx bx-moon' ></i>
                        <i class='sun bx bxs-sun hide' ></i>
                    </span>
                    <version-text> </version-text>
                    <div class="lists">

                    </div>
                </div>

                <div class="right">
                    <span class="weather">
                        <value>-</value> <celcus>Â°C</celcus>
                    </span>
                </div>

            </header>

            <section class="committers">

                <div class="current-comitter unshow">
                    <h5>from <repo> </repo> </h5>
                    <h1> </h1>
                    <div class="about-committer">
                        <h3> <img src=""> Committed by <author> </author> </h3>
                        <div class="experience-comitter">
                            <span><i id="icon" class='bx bx-chevron-up'></i> <value></value></span>
                        </div>
                    </div>
                </div> 

                <div class="scoreboard">

                    
                </div>

            </section>

        </aside>

    </aside>

</body>
<footer>
    <script src="./apps/restapi.js"></script>
    <script src="./apps/screen.js"></script>
    <script src="./apps/event.js"></script>
    <script>

            


            const d = document;
            const schedule = [

                // Recurring event

                { day: [1], hour: 9, minute: 0, title:"Check-in", link: 'zoommtg://zoom.us/join?confno=83251922994&pwd=QlMwV2J3N2lDbGFmQkdaN0FYalNzZz09' },

                { day: [1, 2, 3, 4, 5], hour: 20, minute: 59, title: "Speaker Of the Day", link: 'zoommtg://zoom.us/join?confno=84822594283&pwd=eXhPV1BUdVBGU1BXaWVaQllqN0luZz09' },

                { day: [1, 2, 3, 4, 5], hour: 11, minute: 45, title: "Stand-up", link: 'zoommtg://zoom.us/join?confno=83392530685&pwd=SEdOTUpibVlOTTU0bDFHNEdPVll5QT09' },

                { day: [5], title: "France Wrap-up", hour: 15, minute: 30, link: 'zoommtg://zoom.us/join?confno=87494744554&pwd=YzJkZ3lvMml3QXpjejRvaWRYaDVtQT09' },


                // Temporary event


            ];
    

            d.querySelector('.moon').addEventListener('click', () => {
                d.querySelector('.moon').classList.add('hide');
                d.querySelector('.sun').classList.remove('hide');
                d.querySelector('html').classList.add('dark-theme')
            })

            d.querySelector('.sun').addEventListener('click', () => {
                d.querySelector('.sun').classList.add('hide');
                d.querySelector('.moon').classList.remove('hide');
                d.querySelector('html').classList.remove('dark-theme')
            })



            let last_commit;
            async function handleScreen () {

                api('commits/pending?limit=1', (request) => {
                    const commits = request.results;
                    if (commits.length > 0) 
                    {
                        const commit = commits[0];
                        if (!last_commit || last_commit != commit.ID)
                        {

                            const xpTotal = commit.XP;
                            screen.update.commit.count(0);
                            screen.update.commit.element(commit)


                            function updateExperienceCount() {
                                let xpCount = 0;

                                const increment = xpTotal > 0 ? 1 : -1;

                                function updateScreen() {
                                    screen.update.commit.count(xpCount);
                                }

                                function animate() {
                                    xpCount += increment;
                                    updateScreen();
                                    if (xpCount !== xpTotal) {
                                        setTimeout(animate, 50);
                                    }
                                }

                                setTimeout(() => animate(), 1000)
                            }
                            if (xpTotal != 0)
                                updateExperienceCount()

                            setTimeout(() => api('commits/displayed/'+ commit.ID), 5000)
                            
                            last_commit = commit.ID;

                        }


                    }

                } )
                api('users/scoreboard', (request) => {                  
                    screen.scoreboard = request.results
                    screen.update.scoreboard(screen.scoreboard);

                } )

                setTimeout(() => handleScreen(), 15000);

            }

            let isScheduled = false;

            const handleNextEvent = () => {

                const ev = event.next();
                const date = new Date();


                if ( !ev ) return;

                const event_date = new Date();
                event_date.setHours(ev.hour);
                event_date.setMinutes(ev.minute);
                event_date.setSeconds(0);
                event_date.setMilliseconds(0);

                const diff = new Date(event_date.getTime() - date.getTime());

                // screen.update.event(ev.title, diff);

                const ONE_HOUR = (60000 * 60);

                if ( diff.getTime() < ONE_HOUR)
                {

                    if (diff.getMinutes() < 5 && !isScheduled)
                    {

                        window.open(ev.link);
                        isScheduled = true;
                        setTimeout(async () => isScheduled = false, 300000)

                    }

                }
            }


            async function handleWeather () {

                api('platforms/weather/toulouse', (weather) => screen.update.weather( weather.temperature ) )

                setTimeout(() => handleWeather(), 60000)

            }

            async function handleVersion () {

                api('platforms/version', function (status) {

                    if (screen.version && screen.version != status.interface) 
                    {

                        location.reload()

                    }

                    screen.version = status.interface

                    screen.update.version( screen.version);

                } )
                setTimeout(() => handleVersion(), 10000)

            }


            async function initializeEvent () {

                const events = d.querySelector('header .lists');

                for (const event of schedule)
                {

                    const { title, link } = event;

                    events.innerHTML += `<a href="${link}" target="_blanl">${title}</a>`;

                }
            }

            initializeEvent();
            handleScreen();
            handleVersion()
            handleWeather();

    </script>
    
</footer>
</html>
